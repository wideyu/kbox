<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<!--
Created using JS Bin
http://jsbin.com
Copyright (c) 2018 by SaraVieira (http://jsbin.com/zarakid/14/edit)
Released under the MIT license: http://jsbin.mit-license.org
-->
<meta name="robots" content="noindex">
  <meta name="viewport" content="width=device-width">
  <title>kbox 1613</title>

<style id="jsbin-css">
body {
  background: #f5f5f5;
}
body h1 {
  text-align: left;
  font-family: arial;
  color: #5a5a5a;
}
body ul {
  display: flex;
  list-style: none;
  flex-wrap: wrap;
  align-items: flex-start;
  justify-content: center;
  flex-basis: 80%;
}
body ul li {
  flex-basis: 20%;
  display: flex;
  flex-direction: column;
  margin-bottom: 20px;
  align-items: center;
}
body ul li span {
  font-family: arial;
  font-size: 14px;
  color: #5a5a5a;
  text-align: center;
}
body ul li img {
  margin: 5px;
  border-radius: 3px;
  box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
}
</style>
</head>
<body>

<audio id="kbox" controls> 
  Your browser does not support the audio element.
</audio>
  <div id="Path"></div>
    <div id="time"></div><br></br>
  <div id="container" style="width:90%;">
  </div>
<script src="fetch.umd.js"></script>
<script src="polyfill.min.js"></script>
<script src="fetchPolyfill.js"></script>
<script>
//'use strict';
function createNode(element) {
  return document.createElement(element);
}
function append(parent, el) {
  return parent.appendChild(el);
}
function getQueryVariable(variable)
{
       var query = window.location.search.substring(1);
       var vars = query.split("&");
       for (var i=0;i<vars.length;i++) {
               var pair = vars[i].split("=");
               if(pair[0] == variable){return pair[1];}
       }
       return("");
}

var isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
  if(isChrome){
    var ifrm = document.createElement("iframe");
    ifrm.setAttribute("src", "silence.mp3"); 
    ifrm.setAttribute("allow", "autoplay"); 
    ifrm.setAttribute("id", "audio");
    ifrm.setAttribute("style", "display:none");
    document.body.appendChild(ifrm);
  }
var lang = getQueryVariable("lang") || navigator.language || navigator.userLanguage; 
var path = getQueryVariable("path");
var listUrl = 'https://bird.ioliu.cn/v2?url=http://m.kugou.com/app/i/fmSongs.php?fmid=63&size=20&offset=';
var getSong = 'https://bird.ioliu.cn/v2?url=http://m.kugou.com/app/i/getSongInfo.php?cmd=playInfo&hash='
var ul = document.getElementById('authors');
var table = document.createElement('table');
var div = document.getElementById('container');
            div.innerHTML = '';
            div.appendChild(table);    // ADD THE TABLE TO THE WEB PAGE.
document.getElementById('Path').innerHTML = '<h1>'+path+'</h1>';

document.getElementById('time').innerHTML = new Date().toLocaleString();
var songs = [];
var offsets = '%7B%22offset%22%3A20%2C%22time%22%3A' + Date.now() + '%7D';
fetch(listUrl+offsets).then(function (resp) {
  return resp.json();
}).then(function (json) {
    var len = json.data[0].songs.length;
    offsets = json.data[0].offset;
    console.log(listUrl);
    console.log(offsets);
    for (var i = 0; i < len; i++) {
        fetch(getSong + json.data[0].songs[i]['320hash'])
            .then(function (resp) {
                return resp.json();
            })
            .then(function(songJson) {
                var src = songJson.url;
                if (src.trim() != '') songs.push({'src': src, 'name': songJson.fileName});
            });
    }
})['catch'](function (error) {
  console.log(error);//JSON.stringify(error));
});

setInterval(showSongs, 5000);
function showSongs() {
    console.log(table.rows.length);
    console.log(songs.length);
    if (table.rows.length >= songs.length) return;
    for (var i = 0; i < songs.length; i++) {
        if (table.rows.length <= songs.length) {
            tr = table.insertRow(-1);
            tr.innerHTML = "<td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>";
        }
        tr = table.rows[i];
        tr.cells.item(0).innerHTML = songs[i].name;
    }
    for (var i = songs.length; i < table.rows.length; i++) {
        if (table.rows.length > songs.length) {
            table.deleteRow(table.rows.length-1);
        }
    }
}

setTimeout(playStart, 1000);
var index = 0;
function playStart() {
                    console.log(songs.length);
    if (songs.length == 0) {
        setTimeout(playStart, 1000);
        return;
    }
                    //document.getElementById('kbox').innerHTML = "<audio id='kbox' src='" + songUrl + "' autoplay='autoplay' controls></audio>";
    kbox.setAttribute("src", songs[index].src);
                    document.getElementById('kbox').setAttribute("autoplay", 'autoplay');
                    //console.log(document.getElementById('kbox').innerHTML);
                    document.getElementById('kbox').load();
                    //document.getElementById('kbox').play();
    document.getElementById('kbox').play();
    document.getElementById('time').innerHTML = songs[index].name;
    kbox.addEventListener("ended", function() {
            playNextSongAuto()
        }, true);
fetch(listUrl+offsets).then(function (resp) {
  return resp.json();
}).then(function (json) {
    var len = json.data[0].songs.length;
    offsets = json.data[0].offset;
    console.log(listUrl);
    console.log(offsets);
    for (var i = 0; i < len; i++) {
        fetch(getSong + json.data[0].songs[i]['320hash'])
            .then(function (resp) {
                return resp.json();
            })
            .then(function(songJson) {
                var src = songJson.url;
                if (src.trim() != '') songs.push({'src': src, 'name': songJson.fileName});
            });
    }
})['catch'](function (error) {
  console.log(error);//JSON.stringify(error));
});
}

function playNextSongAuto() {
    index++;
    if (index >= songs.length) index = 0;
    kbox.setAttribute("src", songs[index].src);
    kbox.load();
    kbox.play();
    document.getElementById('time').innerHTML = songs[index].name;
}

</script>

</body>
</html>
